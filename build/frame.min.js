!function(){"use strict";function e(){console.log.apply(this,arguments)}function t(e,t){"object"==typeof module&&"object"==typeof module.exports&&(module.exports=t),"object"==typeof global?global[e]=t:"function"==typeof define&&define.amd?define(["exports"],function(n){n[e]=t}):"object"==typeof window&&(window[e]=t)}function n(e,t){for(const n of Object.getOwnPropertyNames(t))"name"!==n&&("object"==typeof t[n]?Array.isArray(t[n])?e[n]=[]:e[n]=Object.create(t[n],Object.getOwnPropertyDescriptors(t[n])):Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n)));return e}function r(e,t,n){Object.defineProperty(e,"toString",{enumerable:!1,writable:!1,configurable:!0,value:function(){return t?"[Frame: "+t+"]":"[Frame: Constructor]"}}),Object.defineProperty(e,"name",{enumerable:!1,writable:!1,configurable:!!n,value:t})}function o(e,t){const n=t?Array.from(t):[];if(!e)return n;const r={};let o=0;for(const t of e)r[t.name]=n[o],o++;return 0===o?t:r}function i(){if(this.Frame.processingFlow)return;if(this.Frame.pipes.length<1)return;if(!function(){if(!this.Frame.initialized)return a.call(this,i),!1;let e=!0;for(const t of this.Frame.pipes){const n=t.target;n.stub||(n.Frame.loaded?n.Frame.initialized||(a.call(n,i.bind(this)),e=!1):e=!1)}return e}.call(this))return;e("Processing flow for "+this.name),e(),this.Frame.processingFlow=!0,this.Frame.pipes.unshift({direction:"to",target:this});let t=1;for(const e of this.Frame.pipes){const n=e.target;if(!this.Frame.pipes[t-1]||n!==this.Frame.pipes[t-1].target)if("from"===e.direction){if("function"!=typeof n.on)throw new Error("Blueprint '"+n.name+"' does not support events.");s.call(this,e,0,this.Frame.events)}else"to"===e.direction&&(s.call(this,e,t,this.Frame.flow),t++)}(function(){e("Starting flow for "+this.name);for(const t of this.Frame.events){const n=t.target,r=o(n.Frame.describe.on,t.params);n.Frame.pipes&&n.Frame.pipes.length>0?e(this.name+" is not starting "+n.name+", waiting for it to finish"):n.Frame.processingFlow||n.on.call(n,r)}}).call(this)}function s(e,t,n){const r=new c(e.target.out),o=new c(e.target.error);e.target.out=r.bind(this,t),e.target.error=o.bind(this,t),n.push(e)}function a(t){const n=this;try{let r=n.Frame.props?n.Frame.props:{};n.init||(n.init=function(e,t){t()}),r=o(n.Frame.describe.init,r),n.init.call(n,r,function(r){if(r)return e("Error initializing blueprint '"+n.name+"'\n"+r);e("Blueprint "+n.name+" intialized"),n.Frame.props={},n.Frame.initialized=!0,t&&t.call(n)})}catch(e){throw new Error("Blueprint '"+n.name+"' could not initialize.\n"+e)}}function c(e){return function(){return e.apply(this,arguments)}}e.error=function(){console.error.apply(this,arguments)},e.warn=function(){console.warn.apply(this,arguments)};const l={to:function(e){return m.call(this,"to",e,Array.from(arguments).slice(1)),this},from:function(e){return m.call(this,"from",e,Array.from(arguments).slice(1)),this},out:function(t,n){e(this.name+".out:",n,arguments),p(h,this,[t,null,n])},error:function(e,t){p(h,this,[e,t])},get value(){if(!this.Frame)return"";const e=this;return new Promise(function(t,n){e.Frame.isPromised=!0,e.Frame.promise={resolve:t,reject:n}})}};function u(e){const t={};return n(t,l),t.stub=!0,t.Frame={parents:[],describe:[]},"function"==typeof e?(r(t,"Function"),t.in=e,t.on=e):(r(t,"Primitive"),t.in=function(){return e},t.on=function(){this.out(e)}),t}function f(e,t,n,r){const o=e.name;clearTimeout(n.Frame.debounce[o]),n.Frame.debounce[o]=setTimeout(function(){delete n.Frame.debounce[o],e.apply(n,r)},t)}function p(e,t,n){t.Frame.queue||(t.Frame.queue=[]),t.Frame.queue.push(setTimeout(function(){e.apply(t,n)},1))}function d(e){return function(){return e.apply(this,arguments)}}function m(t,n,r){if(!this)throw new Error("Blueprint method called without instance, did you assign the method to a variable?");if(!this.Frame||!this.Frame.pipes)throw new Error("Not working with a valid Blueprint object");if(!n)throw new Error(this.Frame.name+"."+t+"() was called with improper parameters");"function"==typeof n&&"function"!=typeof n.to?n=u(n):"function"!=typeof n&&(n=u(n));let o=this;o.instance||(o=o()),e(t,"(): "+this.name),this.Frame.pipes.push({direction:t,target:n,params:r}),n&&n.Frame&&n.Frame.parents.push({target:this,hasCalled:!1}),f(i,1,this)}function h(t,n,r){if(console.log("next:",t),n)return e.error("TODO: handle error:",n),void(this.Frame.processingFlow=!1);const i=this.Frame.flow[t];if(!i||!i.target){this.Frame.processingFlow=!1,this.Frame.isPromised&&(this.Frame.promise.resolve(r),this.Frame.isPromised=!1);const n=this.Frame.parents;if(n.length>0)for(const t of n){let n=t.target;e("Calling parent "+n.name,"for",this.name),e("Data:",r),p(h,n,[0,null,r])}return e("End of flow for",this.name,"at",t)}!function(e,t){const n=e.target,r=o(n.Frame.describe.in,e.params),i=n.in.call(n,t,r,new d(w).bind(n)),s=typeof i;if("undefined"===s)return;"object"===s&&i instanceof Promise?i.then(n.out).catch(n.error):"object"===s&&i instanceof Error?n.error(i):n.out(i)}(i,r)}function w(e,t){return e?this.error(e):this.out(t)}const b={name:"",describe:["init","in","out"],props:{},loaded:!1,initialized:!1,processingFlow:!1,debounce:{},parents:[],pipes:[],events:[],flow:[]};function y(e){if("function"==typeof e)return{type:e.name,expects:e};"object"!=typeof e&&(e={});const t=Object.create(e);Object.assign(t,e);for(const e of Object.keys(t))if("function"==typeof t[e])t[e]={required:!0,type:typeof t[e]()};else if("object"==typeof t[e]&&Array.isArray(t[e])){const n=t[e];t[e]={required:!1,type:"optional",types:[]};for(const r of n)"function"==typeof r&&t[e].types.push(typeof r())}else"object"==typeof t[e]&&t[e].type?t[e]={required:!0,type:t[e].type,expects:t[e].expects}:t[e]={required:!0,type:typeof t[e]};function n(e,n){return!t[e]||(!(!t[e].required||typeof n!==t[e].type)||(t[e].required||"optional"!==t[e].type?!(!t[e].required||!t[e].type||"function"!=typeof t[e].expects)&&t[e].expects(n):!(n&&!t[e].types.includes(typeof n))))}return function(e){const r={},o=e;for(const i of Object.getOwnPropertyNames(e)){const s=Object.getOwnPropertyDescriptor(e,i);if(s.writable&&s.configurable)if(t[i]){r[i]=e[i],Object.defineProperty(o,i,{enumerable:s.enumerable,configurable:s.configurable,get:function(){return r[i]},set:function(e){if(!n(i,e))throw t[i].expects?(e="string"==typeof e?e:typeof e,new Error('Expecting "'+i+'" to be "'+t[i].type+'", got "'+e+'"')):"optional"===t[i].type?new Error('Expecting "'+i+'" to be one of "'+t[i].types+'", got "'+typeof e+'"'):new Error('Expecting "'+i+'" to be a "'+t[i].type+'", got "'+typeof e+'"');return r[i]=e,e}});for(const i of Object.getOwnPropertyNames(t))o[i]||(r[i]=e[i],Object.defineProperty(o,i,{enumerable:s.enumerable,configurable:s.configurable,get:function(){return r[i]},set:function(e){if(!n(i,e))throw t[i].expects?(e="string"==typeof e?e:typeof e,new Error('Expecting "'+i+'" to be "'+t[i].type+'", got "'+e+'"')):"optional"===t[i].type?new Error('Expecting "'+i+'" to be one of "'+t[i].types+'", got "'+typeof e+'"'):new Error('Expecting "'+i+'" to be a "'+t[i].type+'", got "'+typeof e+'"');return r[i]=e,e}}));o[i]=e[i]}else Object.defineProperty(o,i,s);else Object.defineProperty(o,i,s)}return o}}y.StringNotBlank=y(function(e){return"string"==typeof e&&e.trim().length>0});const g=new y({name:y.StringNotBlank,init:[Function],in:[Function],on:[Function],describe:[Object],out:Function,error:Function,close:[Function],to:Function,from:Function});function F(e,t,n){t||(e=e.path||"");var r={filename:e,exports:{},Blueprint:null,resolve:{},require:function(e,t){return window.http.module.in.call(window.http.module,e,t)}};if(!n)return r;r.resolve[r.filename]=function(e){n(null,e),delete r.resolve[r.filename]};const o='module.resolve["'+e+'"](function(iifeModule){\n  var module = Module(iifeModule)\n  var __filename = module.filename\n  var __dirname = __filename.slice(0, __filename.lastIndexOf("/"))\n  var require = module.require\n  var exports = module.exports\n  var process = { browser: true }\n  var Blueprint = null;\n\n(function() {\n"use strict";\n'+t+"\n}).call(module.exports);\n  if (Blueprint) { return Blueprint}\n  return module.exports\n}(module));";return window.module=r,window.global=window,window.Module=F,window.require=function(e,t){return window.http.module.init.call(window.http.module),window.http.module.in.call(window.http.module,e,t)},o}const j={name:"loaders/http",protocol:"loader",loaded:!0,callbacks:[],module:{name:"HTTP Loader",protocol:["http","https","web://"],init:function(){this.isBrowser="object"==typeof window},in:function(e,t,n){return this.isBrowser?this.browser.load.call(this,e,n):n("URL loading with node.js not supported yet (Coming soon!).")},normalizeFilePath:function(e){if(e.indexOf("http")>=0)return e;return"blueprints/"+(e+(-1===e.indexOf(".js")?".js":""))},browser:{load:function(t,n){const r=this.normalizeFilePath(t);e("[http loader] Loading file: "+r);var o=!0,i=null;n||(o=!1,n=function(e,t){if(e)throw new Error(e);return i=t});const s=new XMLHttpRequest,a=new this.browser.scriptEvents(this,t,n);return s.addEventListener("load",a.onLoad),s.addEventListener("error",a.onError),s.open("GET",r,o),s.send(null),i},scriptEvents:function(e,t,n){this.callback=n,this.fileName=t,this.onLoad=e.browser.onLoad.call(this,e),this.onError=e.browser.onError.call(this,e)},onLoad:function(e){const t=this;return function(){if(this.status>400)return t.onError.call(this,this.statusText);const n=F(this.responseURL,this.responseText,t.callback);var r=document.documentElement,o=document.createElement("script");o.textContent=n,r.appendChild(o),e.browser.cleanup(o,t)}},onError:function(t){const n=this,r=n.fileName;return function(){if(t.browser.cleanup(this,n),-1===r.indexOf(".js")&&-1===r.indexOf("index.js"))return e.warn("[http] Attempting to fallback to: ",r+"/index.js"),t.in.call(t,r+"/index.js",n.callback);n.callback("Could not load Blueprint")}},cleanup:function(e,t){e.removeEventListener("load",t.onLoad),e.removeEventListener("error",t.onError)}},node:{}}};t("http",j);const v={"loaders/http":j,"loaders/file":{name:"loaders/file",protocol:"embed",loaded:!0,callbacks:[],module:{name:"File Loader",protocol:"file",init:function(){this.isBrowser="object"==typeof window},in:function(t,n,r){if(this.isBrowser)throw new Error("File:// loading within browser not supported yet. Try relative URL instead.");e("[file loader] Loading file: "+t);const o=require("vm"),i=require("fs"),s=this.normalizeFilePath(t),a=this.resolveFile(s);if(!a)return r("Blueprint not found");const c=i.readFileSync(a).toString();global.Blueprint=null,o.runInThisContext(c),r(null,global.Blueprint)},normalizeFilePath:function(e){return require("path").resolve(process.cwd(),"blueprints/",e)},resolveFile:function(e){const t=require("fs"),n=require("path");if(t.existsSync(e))return t.statSync(e).isDirectory()?n.resolve(e,"index.js"):e+(-1===e.indexOf(".js")?".js":"");const r=e+(-1===e.indexOf(".js")?".js":"");return!!t.existsSync(r)&&r}}}};function E(e){return{file:e,path:e,name:e.trim().toLowerCase(),protocol:function(e){if(!e||"string"!=typeof e)throw new Error("Invalid loader blueprint name");var t=e.match(/:\/\//gi)&&e.split(/:\/\//gi);return t?t[0]:"object"==typeof window?"http":"file"}(e)}}const x=function(t,n,r){try{const o=E(t),i=o.name,s=o.protocol;if(e("loading module:",i),v[i])return v[i].loaded?r(v[i].module):v[i].callbacks.push(r);v[i]={fileName:i,protocol:s,loaded:!1,callbacks:[r]};const a="loaders/"+s;v[a].module.init(),v[a].module.in(i,n,function(t,n){if(t)e("Error: ",t,i);else{if(e("Loaded Blueprint module: ",i),!n||"object"!=typeof n)throw new Error("Invalid Blueprint file, Blueprint is expected to be an object or class");if("string"!=typeof n.name)throw new Error("Invalid Blueprint file, Blueprint missing a name");const t=v[i];if(!t)throw new Error("Uh oh, we shouldnt be here");if(t.loaded)throw new Error('Blueprint "'+n.name+'" already loaded.');t.module=n,t.loaded=!0,function(e){for(const t of e.callbacks)t(e.module);e.callbacks=[]}(t)}})}catch(e){throw new Error("Could not load blueprint '"+t+"'\n"+e)}},O={};function B(t,o){if(!(this instanceof B))return new B(t,o);if("string"!=typeof t)throw new Error("Blueprint name '"+t+"' is not valid.\n");if(O[t])return O[t];let s=new P(t);return x(t,o,function(o){try{if(e("Blueprint loaded:",o.name),"object"!=typeof o)throw new Error("Blueprint is expected to be an object or class");n(s,o),r(s,o.name,!1),s.Frame.name=o.name,(s=g(s)).Frame.describe=function(e,t){const n={};e||(e={});for(const e of t)n[e]=[];for(const t of Object.keys(e)){if(n[t]=[],"object"!=typeof e[t]||Array.isArray(e[t]))continue;const r=[];for(const n of Object.keys(e[t]))r.push({name:n,description:e[t][n]});n[t]=r}return n}(s.describe,b.describe),s.Frame.loaded=!0,f(i,1,s),s.singleton&&(O[s.name]=s)}catch(e){throw new Error("Blueprint '"+t+"' is not valid.\n"+e)}}),s}function P(e){const t=new q(e);r(t,"Blueprint",!0),n(t,l);const o=Object.create(b);return n(o,b),Object.defineProperty(t,"Frame",{value:o,enumerable:!0,configurable:!0,writable:!1}),t.Frame.name=e,t}function q(e){return function(){if(O[e])return O[e];const t=new B(e);return t.Frame.props=arguments,t}}r(B,"Constructor"),r(B.constructor,"Frame"),t("Frame",B)}();
